### question
1. 为什么 fund_hub 中任务为IO 密集型任务

- 问题的背景
- 解决问题前的现象
- 怎么样解决的
- 解决过程中遇到的难点
- 需要注意的点
- 解决后的现象
## 任务监控系统
- 背景：核心接入系统中有每天每个资金方有很多定时任务需要处理（对账，合同替换）
监控系统的告警，目前有什么问题。
- 存在潜在风险，众多的定时任务执行时，没有统一的监控平台去感知这些任务正常执行，异常退出还是未执行
- 配置表（渠道ID + 任务名称唯一键），执行表，流水表。配置表配置每个需要监控的任务（渠道id + 任务名，生效状态，任务的执行时间间隔类型，执行的时间天，小时，分钟预计执行的最长时间，告警ID 告警频率，配置人，时间戳
- 执行表：任务配置ID，任务执行key, 任务执行状态（未执行，执行中，执行完毕），实际开始结束时间和预计开始结束时间，告警次数
- 流水表：任务配置ID，任务执行ID，告警类型，告警时间，时间戳。
1. 不能影响正常的任务执行，不允许抛出任何异常。
2. 要和被监控的服务解耦，不然被监控服务挂掉后监控也无效了
3. 告警机制，告警频率，最大告警次数，预留缓冲时间

## 对账系统：
以前各个资方各自实现自己的对账功能，零散对账，对账的告警由各自开发同学进行关注每天任务繁忙

出现问题：
1. 对账记录没有持久化存储
2. 对账信息不能通过一个集中式的平台查看不利于运营管理。
3. 周末节假日容易错过告警消息，导致数据与资方不一致。

解决方案：
1. 通过对账系统统一对各个资方的数据进行对账处理。
2. 放款对账规则表，放款数据表存储资方的放款数据，放款明细对账结果表，放款汇总对账结果表。
3. 用mq 削峰落地资方放款数据，低频瞬时切时效性不高的场景。

## 核心接入系统：
### 接入层
落地授信放款还款数据
上游发给我们的用户授信申请，放款申请还款申请并且已经匹配好这笔申请属于哪个资方。

### 配置规则引擎
- 渠道：一个资方，包含渠道id，

- 行为：对在接入层落地到表的一条数据处理，一个行为是包含多个步骤，这个步骤可以暂时理解为系统执行的最小单元，这些步骤组成了一个单边有向图，在这个有向图中有初始态中间态终态。

- 步骤：系统执行的最小单元，与资方或者上游的一次交互，主动调用，回调类型。步骤包含：与资方的加解密处理器，发送和接收的报文模板以及解析资方报文后的应该去到的下一个步骤（就是节点在有向图中指向的下一个节点）都存储在step中。

- 步骤细节：调用的时候会解析这个模板，通过执行报文配置的处理器得到最终的发送报文，再通过加解密处理器发送给资方，得到资方的返回报文对报文解析后，判断下一步到哪里去。

- 处理器：从效果上来说就是一次方法的执行，主要存在与发送报文模板中，大多数字段的获取都是通过处理器完成，处理器之间可以相互调用。把代码中的方法，包括类的路径，方法名称，入参，返回参数，自定义的中文方法名称存储在数据库，利用Java 反射机制，在运行时通过类的全路径，方法名称，入参执行调用的方法。


使用调度系统对行为进行调度，会判断在哪一个步骤，进行处理

还款试算的场景，上游提前对正常还款批任务处理的场景进行试算缓存，大量的瞬时流量请求到系统中。
1. 优化点上游提前对批扣场景进行分片处理
2. 对还款计划做缓存，一天只查询一次资金方接口。

如果用削峰加回调的模式可能会出现什么问题：
1. 消息丢失
2. 失败策略怎么处理，如果一直是失败怎么处理，设置封装成一个dto后设置一个ttl ，再放到告警队列中告警处理。
3. mq 的消费策略是怎么样的，是不是先进先出，如果不是有可能存在一直没有被消费的消息
4. 如何判断什么时候可以去消费mq, 当设置有最大值时不去消费渠道的消息
5. 跨天消息不能消费，十一点半清空队列
6  把两个流量入口合并成一个并封装其请求设置ttl ,每次调用后-1，为0时放到告警队列。


### 慢查询的优化：
1. 建表以后的新加的时间字段没有建索引，少数资方使用到，导致慢查询
2. channel 索引删除与 createTime 做联合索引
3. 区分度高的 status 与 proc 联合索引，运营系统需要对正在处理中的订单进行监控。
4. 
