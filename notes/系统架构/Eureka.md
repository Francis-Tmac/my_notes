## 服务治理-概念&技术选型
### 面临的问题
1. 服务注册-服务当前是可用状态or 下线状态

2. 服务发现-服务消费者拉取注册数据，服务调用方，来自哪里

3. 心跳检测，服务续约和服务剔除，一套服务提供方的注册中心配合完成的去伪存真的过程

4. 服务下线-服务提供方发起主动下线

### 技术选型
#### 分布式系统 CAP 定理
* 一致性： 在分布式环境中分布的所有节点，比如数据库主从备份，redis集群，在集群中每一个节点都保存着一个数据的副本。同一个时刻同一个值在每个副本中的值都是一样的。指数据的一致性。

强一致性：对系统中的一个数据做更新操作，在这次更新操作后，所有的访问请求都能取到更新过后的值，一次更新终生有效。
弱一致性：：对系统中的一个数据做更新操作，在这次更新操作后，有一部分或者所有的访问请求都不能取到更新过后的值。
最终一致性：经过一段时间后，能保证在未来的某个时间节点，能取到更新以后的数据。

大部分超高并发的应用，大多都是使用的最终一致性。
分布式中的一致性说的是强一致性
* 可用性：即便有部分机器处于宕机状态，要保证系统整体的可用性
* 分区容错性：异地机房做容灾，机房间的数据是在相互做同步的。假设某个时间两个机房间的通讯被中断了，产生数据不一致的情况。对于支持分区容错性 的系统来说，要做二选一的情况。当选择可用性时一致性可能会有问题，当选择一致性时可用性会有问题，等数据同步回复才能提供服务。所以需要在可用性和一致性之间做一个抉择。
CAP 定理：分布式系统只能三选二，不能全占。

#### 三大门派
##### Eureka
##### Consul 挂牌于 spring cloud 下的
##### Nacos 挂牌于 spring cloud alibaba 主键库 下的


header 1 | Eureka | consul | Nacos
---|---|---|---|
一致性  | 弱一致性（AP）| 弱一致性  | AP/ CP
性能    | 快            |慢（RAFT 协议 Leader选举） | 快 
网络协议| HTTP          |HTTP&DNS   | HTTP,DNS,UPD
应用广度|目前主流       |目前非主流 |稳中有升，尚待观察

选举leader,重新选举时处于不可用的状态



## 服务治理全链路

### 服务注册
发起注册前：代理+装饰器模式构建的组件化架构
服务注册的核心流程和状态扭转

有两种只管的解决方案：
1. 由注册中心主动访问网络上的所有机器
2. 注册中心等待服务节点上门注册

主流都是选择第二种其利弊：
1. 模型复杂，网络环境浩如烟海，轮询每个节点的做法通常是注册中心发局域网广播，客户端响应的方式。对于垮局域网的分布式系统来说，响应模型更加复杂。
2. 网络消耗大：广播的模式增加了网络通信成本。
3. 服务端压力增加：不仅要求注册中心向节点发广播，还要客户端的应答作出响应。尽可能减轻服务中心的承载的业务。

等待情况
1. 提供的什么服务
2. IP地址+ 端口
3. 节点状态
4. 心跳检测和服务剔除，已经注册过的服务节点，会时不时来跟注册中心通信下（心跳检测），如果隔段时间没见着他们了，就从注册名单中把他们删除（服务剔除）
5. 注册信息同步，集群环境下同步给其他的注册中心

配置服务节点的注册中心

### 服务发现
服务节点：扫描注解——》发起注册——》装饰器代理——》代理注册


### 心跳和续约
1. 心跳检测的作用，心跳包含的内容以及控制参数
2. 注册中心服务剔除操作的核心流程

#### 心跳
客户端定时想注册中心同步状态。（包括 app_name,instace_id,服务状态）
注册中心对一段时间无响应的服务做服务剔除。
服务续约
两个核心指标：
每个多久向服务器发送一次心跳包
告诉服务器如果在X 秒内都没有心跳，就代表我挂掉了。

#### 剔除任务
1. 注册中心每隔60秒（默认）会触发服务剔除任务，
2. 看哪些服务启动了服务自保。
3.遍历过期服务，接下来注册中心会遍历所有服务节点，揪出所有过期服务。
* 最后一次心跳时间+ 服务端配置的运行心跳间隔时间< 当前时间
4. 计算可提出服务总个数，服务中心会估计自身稳定性，因此为他设置一个系数 0.85 ，可提出服务数量不能大于已注册服务的总数乘这个系数。
5. 乱序提出

服务下线

剔除和自保



业务系统在保证可扩展性的基本要求下，尽可能支持公司业务的快速增长，往往不会特别在意系统层面的清晰度和组件化。


单个节点挂了怎么办
故障容错，降级流程，忽略某些不必要的模块。
故障恢复，

对注册中心做高可用改造
集群加互相备份
